"use strict";(self.webpackChunkfront=self.webpackChunkfront||[]).push([[193],{6945:(e,t,s)=>{let i;s.d(t,{m:()=>r});const n=new Promise((e=>{i=e})),r=Object.freeze({onReplayReady:i,sessionReplayInitialized:n})},7661:(e,t,s)=>{s.d(t,{o:()=>h});var i=s(3197),n=s(3114),r=s(2041),a=s(8464),o=s(2162);class h extends n.w{constructor(e,t,s){var i;super(s),this.endpoint=e,this.opts=t||{},this.started=!1,this.timeoutHandle=null,this.aborted=!1,this.harvest=new r.M(this.sharedContext),(0,a.L)(this.unload.bind(this)),null===(i=this.sharedContext)||void 0===i||i.ee.on(o.wO.RESET,(()=>this.runHarvest({forceNoRetry:!0})))}unload(){this.aborted||(this.opts.onUnload&&this.opts.onUnload(),this.runHarvest({unload:!0}))}startTimer(e,t){this.interval=e,this.started=!0,this.scheduleHarvest(null!=t?t:this.interval)}stopTimer(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.aborted=e,this.started=!1,this.timeoutHandle&&clearTimeout(this.timeoutHandle)}scheduleHarvest(e,t){this.timeoutHandle||(null==e&&(e=this.interval),this.timeoutHandle=setTimeout((()=>{this.timeoutHandle=null,this.runHarvest(t)}),1e3*e))}runHarvest(e){if(this.aborted)return;const t=t=>{null!==e&&void 0!==e&&e.forceNoRetry&&(t.retry=!1),this.onHarvestFinished(e,t)};let s,n,r=[];if(this.opts.getPayload){if(s=i.qD({isFinalHarvest:null===e||void 0===e?void 0:e.unload}),!s)return!1;const t=!(null!==e&&void 0!==e&&e.unload)&&s===i.Be;if(n=this.opts.getPayload({retry:t}),!n)return void(this.started&&this.scheduleHarvest());n="[object Array]"===Object.prototype.toString.call(n)?n:[n],r.push(...n)}let a=e=>this.harvest.sendX(e);r.length?a=this.opts.raw?e=>this.harvest._send(e):e=>this.harvest.send(e):r.push(void 0),r.forEach((i=>{a({endpoint:this.endpoint,payload:i,opts:e,submitMethod:s,cbFinished:t,customUrl:this.opts.customUrl,raw:this.opts.raw})})),this.started&&this.scheduleHarvest()}onHarvestFinished(e,t){if(this.opts.onFinished&&this.opts.onFinished(t),t.sent&&t.retry){const s=t.delay||this.opts.retryDelay;this.started&&s?(clearTimeout(this.timeoutHandle),this.timeoutHandle=null,this.scheduleHarvest(s,e)):!this.started&&s&&this.scheduleHarvest(s,e)}}}},8464:(e,t,s)=>{s.d(t,{L:()=>a});var i=s(1997),n=s(3980),r=s(536);if(n.v6){n._A.cleanupTasks=[];const e=n._A.close;n._A.close=()=>{for(let e of n._A.cleanupTasks)e();e()}}function a(e){n.il?((0,r.N)(e,!0),(0,i.bP)("pagehide",e)):n.v6&&n._A.cleanupTasks.push(e)}},6254:(e,t,s)=>{s.r(t),s.d(t,{Aggregate:()=>K});var i=s(101),n=s(2346),r=s(4572),a=s(3889),o=s(3092),h=s(6033),l=s(4613),u=s(7661),c=s(4522),d=s(8958),f=s(6276),m=s(7772),p=new WeakMap,v=new WeakMap,g=new WeakMap,y=new WeakMap,w=new WeakSet,T=new WeakSet;class R{constructor(){(0,i.Z)(this,T),(0,i.Z)(this,w),(0,n.Z)(this,p,{writable:!0,value:void 0}),(0,n.Z)(this,v,{writable:!0,value:[]}),(0,n.Z)(this,g,{writable:!0,value:setTimeout((()=>(0,a.Z)(this,T,Z).call(this)),5e3)}),(0,n.Z)(this,y,{writable:!0,value:!1})}settle(e){!1===(0,h.Z)(this,p)||(void 0===(0,h.Z)(this,p)?(0,h.Z)(this,v).push(e):e())}decide(e){(0,h.Z)(this,y)||((0,o.Z)(this,p,e),!1===e&&(0,a.Z)(this,T,Z).call(this),!0===e&&(0,a.Z)(this,w,b).call(this))}permanentlyDecide(e){(0,h.Z)(this,y)||(this.decide(e),(0,o.Z)(this,y,!0))}}function b(){(0,h.Z)(this,v).forEach((e=>e())),(0,a.Z)(this,T,Z).call(this)}function Z(){(0,o.Z)(this,v,[]),clearTimeout((0,h.Z)(this,g))}var N=s(9700),S=s(6945),F=s(2162);var O=s(1527);const H={global:{mouseup:!0,mousedown:!0},window:{load:!0,pagehide:!0},xhrOriginMissing:{ignoreAll:!0}},A={typing:[1e3,2e3],scrolling:[100,1e3],mousing:[1e3,2e3],touching:[1e3,2e3]},E=6e5;var M=new WeakMap,k=new WeakSet,I=new WeakSet,L=new WeakMap;class K extends O.m{constructor(e,t,s){var r;if(super(e,t,m.FEATURE_NAME),(0,i.Z)(this,I),(0,i.Z)(this,k),(0,n.Z)(this,M,{writable:!0,value:void 0}),(0,n.Z)(this,L,{writable:!0,value:0}),r=this,this.agentRuntime=(0,d.OP)(e),!this.agentRuntime.xhrWrappable)return;this.resourceObserver=null===s||void 0===s?void 0:s.resourceObserver,this.ptid="",this.trace={},this.nodeCount=0,this.sentTrace=null,this.harvestTimeSeconds=(0,d.Mt)(e,"session_trace.harvestTimeSeconds")||10,this.maxNodesPerHarvest=(0,d.Mt)(e,"session_trace.maxNodesPerHarvest")||1e3,this.isStandalone=!1;const a=new R,u=this.agentRuntime.session;this.operationalGate=a;const c=e=>{switch(e){case F.IK.ERROR:this.startTracing(a,!0);break;case F.IK.FULL:case!0:this.startTracing(a);break;case F.IK.OFF:default:a.decide(!1)}};let f,p=!1;this.ee.on(F.wO.UPDATE,((e,t)=>{t.sessionReplayMode===F.IK.FULL&&v()}));const v=()=>{var e;if((null===(e=this.agentRuntime)||void 0===e||null===(e=e.session)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.sessionReplayMode)===F.IK.FULL&&f!==F.IK.FULL){const e=f;f=F.IK.FULL,u.write({sessionTraceMode:f}),this.isStandalone=!1,e===F.IK.ERROR&&(0,h.Z)(this,M)?(this.trimSTNs(3e4),(0,h.Z)(this,M).runHarvest({needResponse:!0})):c(F.IK.FULL)}};if(u){(0,l.X)("errorAgg",(()=>{p=!0,v()}),this.featureName,this.ee);const t=()=>{var e,t;u.state.sessionTraceMode!==F.IK.OFF&&u.write({sessionTraceMode:F.IK.OFF}),a.permanentlyDecide(!1),f===F.IK.FULL&&(null===(e=(0,h.Z)(this,M))||void 0===e||e.runHarvest()),null===(t=(0,h.Z)(this,M))||void 0===t||t.stopTimer(!0),(0,o.Z)(this,M,null)};this.waitForFlags(["stn","sr"]).then((async s=>{let[i,n]=s;if(n)if(this.ee.on("REPLAY_ABORTED",(()=>t())),this.ee.on(F.wO.RESUME,(()=>{const e=u.state.sessionTraceMode;e===F.IK.OFF?t():e===F.IK.FULL&&(0,h.Z)(this,M)&&!(0,h.Z)(this,M).started&&(0,h.Z)(this,M).runHarvest({needResponse:!0}),f=e})),this.ee.on(F.wO.PAUSE,(()=>{f=u.state.sessionTraceMode})),u.isNew){const t=await async function(e){try{const t=(0,N.fP)();if((0,d.Mt)(e,"session_replay.enabled")&&"object"===typeof t.initializedAgents[e].features.session_replay&&await t.initializedAgents[e].features.session_replay.onAggregateImported)return await S.m.sessionReplayInitialized}catch(t){}return F.IK.OFF}(e);let s;t===F.IK.OFF&&(this.isStandalone=!0),s=!0===i||t===F.IK.ERROR&&p?F.IK.FULL:t,u.write({sessionTraceMode:f=s}),c(s)}else u.state.sessionReplayMode===F.IK.OFF&&(this.isStandalone=!0),c(f=u.state.sessionTraceMode);else this.isStandalone=!0,c(i)}))}else this.isStandalone=!0,(0,l.X)("rumresp-stn",(e=>c(e)),this.featureName,this.ee);(0,l.X)("bst",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeEvent(...t)))}),this.featureName,this.ee),(0,l.X)("bstResource",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeResources(...t)))}),this.featureName,this.ee),(0,l.X)("bstHist",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeHist(...t)))}),this.featureName,this.ee),(0,l.X)("bstXhrAgg",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeXhrAgg(...t)))}),this.featureName,this.ee),(0,l.X)("bstApi",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeSTN(...t)))}),this.featureName,this.ee),(0,l.X)("errorAgg",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeErrorAgg(...t)))}),this.featureName,this.ee),(0,l.X)("pvtAdded",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.processPVT(...t)))}),this.featureName,this.ee),this.drain()}startTracing(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"undefined"!==typeof PerformanceNavigationTiming?this.storeTiming(window.performance.getEntriesByType("navigation")[0]):this.storeTiming(window.performance.timing),(0,o.Z)(this,M,new u.o("resources",{onFinished:(0,a.Z)(this,k,x).bind(this),retryDelay:this.harvestTimeSeconds},this)),(0,h.Z)(this,M).harvest.on("resources",(0,a.Z)(this,I,U).bind(this)),!1===t&&(0,h.Z)(this,M).runHarvest({needResponse:!0}),e.decide(!0)}processPVT(e,t,s){this.storeTiming({[e]:t}),function(e,t){return"fi"===e&&!!t&&"number"===typeof t.fid}(e,s)&&this.storeEvent({type:"fid",target:"document"},"document",t,t+s.fid)}storeTiming(e){if(e)for(let t in e){let s=e[t];const i=t.toLowerCase();i.indexOf("size")>=0||i.indexOf("status")>=0||"number"===typeof s&&s>=0&&(s=Math.round(s),this.storeSTN({n:t,s:s,e:s,o:"document",t:"timing"}))}}storeEvent(e,t,s,i){if(this.shouldIgnoreEvent(e,t))return;const n={n:this.evtName(e.type),s:s,e:i,t:"event"};try{n.o=this.evtOrigin(e.target,t)}catch(r){n.o=this.evtOrigin(null,t)}this.storeSTN(n)}shouldIgnoreEvent(e,t){const s=this.evtOrigin(e.target,t);return e.type in H.global||(!(!H[s]||!H[s].ignoreAll)||!(!H[s]||!(e.type in H[s])))}evtName(e){switch(e){case"keydown":case"keyup":case"keypress":return"typing";case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":return"mousing";case"scroll":return"scrolling";case"touchstart":case"touchmove":case"touchend":case"touchcancel":case"touchenter":case"touchleave":return"touching";default:return e}}evtOrigin(e,t){let s="unknown";if(e&&e instanceof XMLHttpRequest){const t=this.ee.context(e).params;if(!t||!t.status||!t.method||!t.host||!t.pathname)return"xhrOriginMissing";s=t.status+" "+t.method+": "+t.host+t.pathname}else if(e&&"string"===typeof e.tagName&&(s=e.tagName.toLowerCase(),e.id&&(s+="#"+e.id),e.className))for(let i=0;i<e.classList.length;i++)s+="."+e.classList[i];return"unknown"===s&&("string"===typeof t?s=t:t===document?s="document":t===window?s="window":t instanceof FileReader&&(s="FileReader")),s}storeHist(e,t,s){const i={n:"history.pushState",s:s,e:s,o:e,t:t};this.storeSTN(i)}storeResources(e){e&&0!==e.length&&(e.forEach((e=>{if((0|e.fetchStart)<=(0,h.Z)(this,L))return;const t=(0,c.e)(e.name),s={n:e.initiatorType,s:0|e.fetchStart,e:0|e.responseEnd,o:t.protocol+"://"+t.hostname+":"+t.port+t.pathname,t:e.entryType};this.storeSTN(s)})),(0,o.Z)(this,L,0|e[e.length-1].fetchStart))}storeErrorAgg(e,t,s,i){if("err"!==e)return;const n={n:"error",s:i.time,e:i.time,o:s.message,t:s.stackHash};this.storeSTN(n)}storeXhrAgg(e,t,s,i){if("xhr"!==e)return;const n={n:"Ajax",s:i.time,e:i.time+i.duration,o:s.status+" "+s.method+": "+s.host+s.pathname,t:"ajax"};this.storeSTN(n)}storeSTN(e){if(this.nodeCount>=this.maxNodesPerHarvest){if(this.isStandalone||this.agentRuntime.session.state.sessionTraceMode!==F.IK.ERROR)return;if(0===this.trimSTNs(3e4))return}this.isStandalone&&(0,f.z)()>=E||(this.trace[e.n]?this.trace[e.n].push(e):this.trace[e.n]=[e],this.nodeCount++)}trimSTNs(e){let t=0;const s=Math.max((0,f.z)()-e,0);return Object.keys(this.trace).forEach((e=>{const i=this.trace[e];let n=i.findIndex((e=>s<=e.e));0!==n&&(n<0?(n=i.length,delete this.trace[e]):i.splice(0,n),this.nodeCount-=n,t+=n)})),t}takeSTNs(e){this.resourceObserver||this.storeResources(window.performance.getEntriesByType("resource"));let t=1/0;const s=Object.entries(this.trace).flatMap((e=>{let[s,i]=e;const n=i.reduce(((e,t)=>!e||t.s<e?t.s:e),void 0);if(n<t&&(t=n),!(s in A))return i;const r=this.smearEvtsByOrigin(s),a=i.sort(((e,t)=>e.s-t.s)).reduce(r,{});return Object.values(a).flat()}),this);if(0===s.length)return{};let i;if(e&&(this.sentTrace=this.trace),this.trace={},this.nodeCount=0,this.agentRuntime.session){const e=!this.agentRuntime.session.state.traceHarvestStarted;i={fsh:Number(e)},e&&this.agentRuntime.session.write({traceHarvestStarted:!0})}return{qs:{st:this.agentRuntime.offset,hr:Number(!this.isStandalone),fts:this.agentRuntime.offset+t,n:s.length,...i},body:{res:s}}}smearEvtsByOrigin(e){const t=A[e][0],s=A[e][1],i={};return(n,r)=>{let a=n[r.o];a||(a=n[r.o]=[]);const o=i[r.o];return"scrolling"!==e||function(e){const t=4;return!!(e&&"number"===typeof e.e&&"number"===typeof e.s&&e.e-e.s<t)}(r)?o&&r.s-o.s<s&&o.e>r.s-t?o.e=r.e:(i[r.o]=r,a.push(r)):(i[r.o]=null,r.n="scroll",a.push(r)),n}}}function x(e){e.sent&&e.responseText&&!this.ptid&&(this.agentRuntime.ptid=this.ptid=e.responseText,(0,h.Z)(this,M).startTimer(this.harvestTimeSeconds)),e.sent&&e.retry&&this.sentTrace&&(Object.entries(this.sentTrace).forEach((e=>{let[t,s]=e;this.nodeCount>=this.maxNodesPerHarvest||(this.nodeCount+=s.length,this.trace[t]=this.trace[t]?s.concat(this.trace[t]):s)})),this.sentTrace=null)}function U(e){if(this.isStandalone){if(this.ptid&&(0,f.z)()>=E)e.isFinalHarvest=!0,this.operationalGate.permanentlyDecide(!1),(0,h.Z)(this,M).stopTimer(!0);else if(this.ptid&&this.nodeCount<=30&&!e.isFinalHarvest)return}else{const e=this.agentRuntime.session.state.sessionTraceMode;if(e===F.IK.OFF&&0===Object.keys(this.trace).length)return;if(e===F.IK.ERROR)return}return this.takeSTNs(e.retry)}(0,r.Z)(K,"featureName",m.FEATURE_NAME)},3092:(e,t,s)=>{s.d(t,{Z:()=>n});var i=s(1519);function n(e,t,s){return function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}(e,(0,i.Z)(e,t,"set"),s),s}}}]);
//# sourceMappingURL=session_trace-aggregate.31669986.chunk.js.map