{"version":3,"file":"static/js/metrics-aggregate.c9b3e7ec.chunk.js","mappings":"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","sources":["../node_modules/@newrelic/browser-agent/dist/esm/common/harvest/harvest-scheduler.js","../node_modules/@newrelic/browser-agent/dist/esm/common/unload/eol.js","../node_modules/@newrelic/browser-agent/dist/esm/features/metrics/aggregate/framework-detection.js","../node_modules/@newrelic/browser-agent/dist/esm/features/metrics/aggregate/index.js"],"sourcesContent":["/*\n * Copyright 2020 New Relic Corporation. All rights reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport * as submitData from '../util/submit-data';\nimport { SharedContext } from '../context/shared-context';\nimport { Harvest } from './harvest';\nimport { subscribeToEOL } from '../unload/eol';\nimport { SESSION_EVENTS } from '../session/constants';\n\n/**\n * Periodically invokes harvest calls and handles retries\n */\nexport class HarvestScheduler extends SharedContext {\n  /**\n     * Create a HarvestScheduler\n     * @param {string} endpoint - The base BAM endpoint name -- ex. 'events'\n     * @param {object} opts - The options used to configure the HarvestScheduler\n     * @param {Function} opts.onFinished - The callback to be fired when a harvest has finished\n     * @param {Function} opts.getPayload - A callback which can be triggered to return a payload for harvesting\n     * @param {number} opts.retryDelay - The number of seconds to wait before retrying after a network failure\n     * @param {boolean} opts.raw - Use a prefabricated payload shape as the harvest payload without the need for formatting\n     * @param {string} opts.customUrl - A custom url that falls outside of the shape of the standard BAM harvester url pattern.  Will use directly instead of concatenating various pieces\n     * @param {*} parent - The parent object, whose state can be passed into SharedContext\n     */\n  constructor(endpoint, opts, parent) {\n    super(parent); // gets any allowed properties from the parent and stores them in `sharedContext`\n    this.endpoint = endpoint;\n    this.opts = opts || {};\n    this.started = false;\n    this.timeoutHandle = null;\n    this.aborted = false; // this controls the per-interval and final harvests for the scheduler (currently per feature specific!)\n\n    this.harvest = new Harvest(this.sharedContext);\n\n    // unload if EOL mechanism fires\n    subscribeToEOL(this.unload.bind(this));\n\n    /* Flush all buffered data if session resets and give up retries. This should be synchronous to ensure that the correct `session` value is sent.\n      Since session-reset generates a new session ID and the ID is grabbed at send-time, any delays or retries would cause the payload to be sent under\n      the wrong session ID. */\n    this.sharedContext?.ee.on(SESSION_EVENTS.RESET, () => this.runHarvest({\n      forceNoRetry: true\n    }));\n  }\n\n  /**\n   * This function is only meant for the last outgoing harvest cycle of a page. It trickles down to using sendBeacon, which should not be used\n   * to send payloads while the page is still active, due to limitations on how much data can be buffered in the API at any one time.\n   */\n  unload() {\n    if (this.aborted) return;\n    // If opts.onUnload is defined, these are special actions to execute before attempting to send the final payload.\n    if (this.opts.onUnload) this.opts.onUnload();\n    this.runHarvest({\n      unload: true\n    });\n  }\n  startTimer(interval, initialDelay) {\n    this.interval = interval;\n    this.started = true;\n    this.scheduleHarvest(initialDelay != null ? initialDelay : this.interval);\n  }\n  stopTimer() {\n    let permanently = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    this.aborted = permanently; // stopping permanently is same as aborting, but this function also cleans up the setTimeout loop\n    this.started = false;\n    if (this.timeoutHandle) {\n      clearTimeout(this.timeoutHandle);\n    }\n  }\n  scheduleHarvest(delay, opts) {\n    if (this.timeoutHandle) return;\n    if (delay == null) {\n      delay = this.interval;\n    }\n    this.timeoutHandle = setTimeout(() => {\n      this.timeoutHandle = null;\n      this.runHarvest(opts);\n    }, delay * 1000);\n  }\n  runHarvest(opts) {\n    if (this.aborted) return;\n\n    /**\n     * This is executed immediately after harvest sends the data via XHR, or if there's nothing to send. Note that this excludes on unloading / sendBeacon.\n     * @param {Object} result\n     */\n    const cbRanAfterSend = result => {\n      if (opts?.forceNoRetry) result.retry = false; // discard unsent data rather than re-queuing for next harvest attempt\n      this.onHarvestFinished(opts, result);\n    };\n    let harvests = [];\n    let submitMethod;\n    let payload;\n    if (this.opts.getPayload) {\n      // Ajax & PVT & SR features provide a callback function to get data for harvesting\n      submitMethod = submitData.getSubmitMethod({\n        isFinalHarvest: opts?.unload\n      });\n      if (!submitMethod) return false;\n      const retry = !opts?.unload && submitMethod === submitData.xhr;\n      payload = this.opts.getPayload({\n        retry\n      });\n      if (!payload) {\n        if (this.started) {\n          this.scheduleHarvest();\n        }\n        return;\n      }\n      payload = Object.prototype.toString.call(payload) === '[object Array]' ? payload : [payload];\n      harvests.push(...payload);\n    }\n\n    /** sendX is used for features that do not supply a preformatted payload via \"getPayload\" */\n    let send = args => this.harvest.sendX(args);\n    if (harvests.length) {\n      /** _send is the underlying method for sending in the harvest, if sending raw we can bypass the other helpers completely which format the payloads */\n      if (this.opts.raw) send = args => this.harvest._send(args);\n      /** send is used to formated the payloads from \"getPayload\" and obfuscate before sending */else send = args => this.harvest.send(args);\n    } else {\n      // force it to run at least once in sendX mode\n      harvests.push(undefined);\n    }\n    harvests.forEach(payload => {\n      send({\n        endpoint: this.endpoint,\n        payload,\n        opts,\n        submitMethod,\n        cbFinished: cbRanAfterSend,\n        customUrl: this.opts.customUrl,\n        raw: this.opts.raw\n      });\n    });\n    if (this.started) {\n      this.scheduleHarvest();\n    }\n  }\n  onHarvestFinished(opts, result) {\n    if (this.opts.onFinished) {\n      this.opts.onFinished(result);\n    }\n    if (result.sent && result.retry) {\n      const delay = result.delay || this.opts.retryDelay;\n      // reschedule next harvest if should be delayed longer\n      if (this.started && delay) {\n        clearTimeout(this.timeoutHandle);\n        this.timeoutHandle = null;\n        this.scheduleHarvest(delay, opts);\n      } else if (!this.started && delay) {\n        // if not running on a timer, schedule a single retry\n        this.scheduleHarvest(delay, opts);\n      }\n    }\n  }\n}","/*\n * Copyright 2020 New Relic Corporation. All rights reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { windowAddEventListener } from '../event-listener/event-listener-opts';\nimport { globalScope, isWorkerScope, isBrowserScope } from '../constants/runtime';\nimport { subscribeToVisibilityChange } from '../window/page-visibility';\nif (isWorkerScope) {\n  globalScope.cleanupTasks = []; // create new list on WorkerGlobalScope to track funcs to run before exiting thread\n\n  const origClose = globalScope.close;\n  globalScope.close = () => {\n    // on worker's EoL signal, execute all \"listeners\", e.g. final harvests\n    for (let task of globalScope.cleanupTasks) {\n      task();\n    }\n    origClose();\n  };\n}\n\n/**\n * Subscribes a provided callback to the time/event when the agent should treat it as end-of-life.\n * This is used, for example, to submit a final harvest and send all remaining data on best-effort.\n * @param {function} cb - func to run before or during the last reliable event or time of an env's life span\n */\nexport function subscribeToEOL(cb) {\n  if (isBrowserScope) {\n    subscribeToVisibilityChange(cb, true); // when user switches tab or hides window, esp. mobile scenario\n    windowAddEventListener('pagehide', cb); // when user navigates away, and because safari iOS v14.4- doesn't fully support vis change\n    // --this ought to be removed once support for version below 14.5 phases out\n  } else if (isWorkerScope) {\n    globalScope.cleanupTasks.push(cb); // close() should run these tasks before quitting thread\n  }\n  // By default (for other env), this fn has no effect.\n}","import { isBrowserScope } from '../../../common/constants/runtime';\nconst FRAMEWORKS = {\n  REACT: 'React',\n  NEXTJS: 'NextJS',\n  VUE: 'Vue',\n  NUXTJS: 'NuxtJS',\n  ANGULAR: 'Angular',\n  ANGULARUNIVERSAL: 'AngularUniversal',\n  SVELTE: 'Svelte',\n  SVELTEKIT: 'SvelteKit',\n  PREACT: 'Preact',\n  PREACTSSR: 'PreactSSR',\n  ANGULARJS: 'AngularJS',\n  BACKBONE: 'Backbone',\n  EMBER: 'Ember',\n  METEOR: 'Meteor',\n  ZEPTO: 'Zepto',\n  JQUERY: 'Jquery',\n  MOOTOOLS: 'MooTools',\n  QWIK: 'Qwik',\n  ELECTRON: 'Electron'\n};\nexport function getFrameworks() {\n  if (!isBrowserScope) return []; // don't bother detecting frameworks if not in the main window context\n\n  const frameworks = [];\n  try {\n    if (detectReact()) {\n      frameworks.push(FRAMEWORKS.REACT);\n      if (detectNextJS()) frameworks.push(FRAMEWORKS.NEXTJS);\n    }\n    if (detectVue()) {\n      frameworks.push(FRAMEWORKS.VUE);\n      if (detectNuxtJS()) frameworks.push(FRAMEWORKS.NUXTJS);\n    }\n    if (detectAngular()) {\n      frameworks.push(FRAMEWORKS.ANGULAR);\n      if (detectAngularUniversal()) frameworks.push(FRAMEWORKS.ANGULARUNIVERSAL);\n    }\n    if (detectSvelte()) {\n      frameworks.push(FRAMEWORKS.SVELTE);\n      if (detectSvelteKit()) frameworks.push(FRAMEWORKS.SVELTEKIT);\n    }\n    if (detectPreact()) {\n      frameworks.push(FRAMEWORKS.PREACT);\n      if (detectPreactSSR()) frameworks.push(FRAMEWORKS.PREACTSSR);\n    }\n    if (detectAngularJs()) frameworks.push(FRAMEWORKS.ANGULARJS);\n    if (Object.prototype.hasOwnProperty.call(window, 'Backbone')) frameworks.push(FRAMEWORKS.BACKBONE);\n    if (Object.prototype.hasOwnProperty.call(window, 'Ember')) frameworks.push(FRAMEWORKS.EMBER);\n    if (Object.prototype.hasOwnProperty.call(window, 'Meteor')) frameworks.push(FRAMEWORKS.METEOR);\n    if (Object.prototype.hasOwnProperty.call(window, 'Zepto')) frameworks.push(FRAMEWORKS.ZEPTO);\n    if (Object.prototype.hasOwnProperty.call(window, 'jQuery')) frameworks.push(FRAMEWORKS.JQUERY);\n    if (Object.prototype.hasOwnProperty.call(window, 'MooTools')) frameworks.push(FRAMEWORKS.MOOTOOLS);\n    if (Object.prototype.hasOwnProperty.call(window, 'qwikevents')) frameworks.push(FRAMEWORKS.QWIK);\n    if (detectElectron()) frameworks.push(FRAMEWORKS.ELECTRON);\n  } catch (err) {\n    // Possibly not supported\n  }\n  return frameworks;\n}\nfunction detectReact() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'React') || Object.prototype.hasOwnProperty.call(window, 'ReactDOM') || Object.prototype.hasOwnProperty.call(window, 'ReactRedux') || document.querySelector('[data-reactroot], [data-reactid]') || (() => {\n      const divs = document.querySelectorAll('body > div');\n      for (let i = 0; i < divs.length; i++) {\n        if (Object.prototype.hasOwnProperty.call(divs[i], '_reactRootContainer')) {\n          return true;\n        }\n      }\n    })();\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectNextJS() {\n  // React SSR\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'next') && Object.prototype.hasOwnProperty.call(window.next, 'version');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectVue() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'Vue');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectNuxtJS() {\n  // Vue SSR\n  try {\n    return Object.prototype.hasOwnProperty.call(window, '$nuxt') && Object.prototype.hasOwnProperty.call(window.$nuxt, 'nuxt');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngular() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'ng') || document.querySelector('[ng-version]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngularUniversal() {\n  // Anguler SSR\n  try {\n    return document.querySelector('[ng-server-context]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectSvelte() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, '__svelte');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectSvelteKit() {\n  // Svelte SSR\n  try {\n    return !!Object.keys(window).find(prop => prop.startsWith('__sveltekit'));\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectPreact() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'preact');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectPreactSSR() {\n  // Svelte SSR\n  try {\n    return document.querySelector('script[type=\"__PREACT_CLI_DATA__\"]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngularJs() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'angular') || document.querySelector('.ng-binding, [ng-app], [data-ng-app], [ng-controller], [data-ng-controller], [ng-repeat], [data-ng-repeat]') || document.querySelector('script[src*=\"angular.js\"], script[src*=\"angular.min.js\"]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectElectron() {\n  try {\n    return typeof navigator === 'object' && typeof navigator.userAgent === 'string' && navigator.userAgent.indexOf('Electron') >= 0;\n  } catch (err) {\n    return false;\n  }\n}","import { getRuntime, getConfiguration } from '../../../common/config/config';\nimport { registerHandler } from '../../../common/event-emitter/register-handler';\nimport { HarvestScheduler } from '../../../common/harvest/harvest-scheduler';\nimport { FEATURE_NAME, SUPPORTABILITY_METRIC, CUSTOM_METRIC, SUPPORTABILITY_METRIC_CHANNEL, CUSTOM_METRIC_CHANNEL } from '../constants';\nimport { getFrameworks } from './framework-detection';\nimport { isFileProtocol } from '../../../common/url/protocol';\nimport { getRules, validateRules } from '../../../common/util/obfuscate';\nimport { onDOMContentLoaded } from '../../../common/window/load';\nimport { windowAddEventListener } from '../../../common/event-listener/event-listener-opts';\nimport { isBrowserScope, isWorkerScope } from '../../../common/constants/runtime';\nimport { AggregateBase } from '../../utils/aggregate-base';\nexport class Aggregate extends AggregateBase {\n  static featureName = FEATURE_NAME;\n  constructor(agentIdentifier, aggregator) {\n    super(agentIdentifier, aggregator, FEATURE_NAME);\n    let scheduler;\n\n    // If RUM-call's response determines that customer lacks entitlements for the /jserror ingest endpoint, don't harvest at all.\n    registerHandler('block-err', () => {\n      this.blocked = true;\n      if (scheduler) scheduler.aborted = true; // RUM response may or may not have happened already before scheduler initialization below\n    }, this.featureName, this.ee);\n\n    // Allow features external to the metrics feature to capture SMs and CMs through the event emitter\n    registerHandler(SUPPORTABILITY_METRIC_CHANNEL, this.storeSupportabilityMetrics.bind(this), this.featureName, this.ee);\n    registerHandler(CUSTOM_METRIC_CHANNEL, this.storeEventMetrics.bind(this), this.featureName, this.ee);\n    this.singleChecks(); // checks that are run only one time, at script load\n    this.eachSessionChecks(); // the start of every time user engages with page\n\n    this.ee.on(\"drain-\".concat(this.featureName), () => {\n      // *cli, Mar 23 - Per NR-94597, this feature should only harvest ONCE at the (potential) EoL time of the page.\n      scheduler = new HarvestScheduler('jserrors', {\n        onUnload: () => this.unload()\n      }, this);\n      scheduler.harvest.on('jserrors', () => ({\n        body: this.aggregator.take(['cm', 'sm'])\n      }));\n    }); // this is needed to ensure EoL is \"on\" and sent\n\n    this.drain();\n  }\n  storeSupportabilityMetrics(name, value) {\n    if (this.blocked) return;\n    const type = SUPPORTABILITY_METRIC;\n    const params = {\n      name\n    };\n    this.aggregator.storeMetric(type, name, params, value);\n  }\n  storeEventMetrics(name, metrics) {\n    if (this.blocked) return;\n    const type = CUSTOM_METRIC;\n    const params = {\n      name\n    };\n    this.aggregator.store(type, name, params, metrics);\n  }\n  singleChecks() {\n    // report loaderType\n    const {\n      distMethod,\n      loaderType\n    } = getRuntime(this.agentIdentifier);\n    if (loaderType) this.storeSupportabilityMetrics(\"Generic/LoaderType/\".concat(loaderType, \"/Detected\"));\n    if (distMethod) this.storeSupportabilityMetrics(\"Generic/DistMethod/\".concat(distMethod, \"/Detected\"));\n    if (isBrowserScope) {\n      this.storeSupportabilityMetrics('Generic/Runtime/Browser/Detected');\n      const nonce = document?.currentScript?.nonce;\n      if (nonce && nonce !== '') {\n        this.storeSupportabilityMetrics('Generic/Runtime/Nonce/Detected');\n      }\n\n      // These SMs are used by the AppExp team\n      onDOMContentLoaded(() => {\n        getFrameworks().forEach(framework => {\n          this.storeSupportabilityMetrics('Framework/' + framework + '/Detected');\n        });\n      });\n    } else if (isWorkerScope) {\n      this.storeSupportabilityMetrics('Generic/Runtime/Worker/Detected');\n    } else {\n      this.storeSupportabilityMetrics('Generic/Runtime/Unknown/Detected');\n    }\n\n    // Track if the agent is being loaded using a file protocol such as is the case in some\n    // set-top box applications or Electron applications\n    if (isFileProtocol()) {\n      this.storeSupportabilityMetrics('Generic/FileProtocol/Detected');\n    }\n\n    // Capture SMs to assess customer engagement with the obfuscation config\n    const rules = getRules(this.agentIdentifier);\n    if (rules.length > 0) this.storeSupportabilityMetrics('Generic/Obfuscate/Detected');\n    if (rules.length > 0 && !validateRules(rules)) this.storeSupportabilityMetrics('Generic/Obfuscate/Invalid');\n\n    // Check if proxy for either chunks or beacon is being used\n    const {\n      proxy,\n      privacy\n    } = getConfiguration(this.agentIdentifier);\n    if (proxy.assets) this.storeSupportabilityMetrics('Config/AssetsUrl/Changed');\n    if (proxy.beacon) this.storeSupportabilityMetrics('Config/BeaconUrl/Changed');\n    if (!(isBrowserScope && privacy.cookies_enabled)) this.storeSupportabilityMetrics('Config/SessionTracking/Disabled');\n  }\n  eachSessionChecks() {\n    if (!isBrowserScope) return;\n\n    // [Temporary] Report restores from BFCache to NR1 while feature flag is in place in lieu of sending pageshow events.\n    windowAddEventListener('pageshow', evt => {\n      if (evt.persisted) {\n        this.storeSupportabilityMetrics('Generic/BFCache/PageRestored');\n      }\n    });\n  }\n  unload() {\n    try {\n      if (this.resourcesSent) return;\n      this.resourcesSent = true; // make sure this only gets sent once\n\n      const agentRuntime = getRuntime(this.agentIdentifier);\n\n      // Capture SMs around network resources using the performance API to assess\n      // work to split this out from the ST nodes\n      // differentiate between internal+external and ajax+non-ajax\n      const ajaxResources = ['beacon', 'fetch', 'xmlhttprequest'];\n      const internalUrls = ['nr-data.net', 'newrelic.com', 'nr-local.net', 'localhost'];\n      function isInternal(x) {\n        return internalUrls.some(y => x.name.indexOf(y) >= 0);\n      }\n      function isAjax(x) {\n        return ajaxResources.includes(x.initiatorType);\n      }\n      const allResources = performance?.getEntriesByType('resource') || [];\n      allResources.forEach(entry => {\n        if (isInternal(entry)) {\n          if (isAjax(entry)) this.storeSupportabilityMetrics('Generic/Resources/Ajax/Internal');else this.storeSupportabilityMetrics('Generic/Resources/Non-Ajax/Internal');\n        } else {\n          if (isAjax(entry)) this.storeSupportabilityMetrics('Generic/Resources/Ajax/External');else this.storeSupportabilityMetrics('Generic/Resources/Non-Ajax/External');\n        }\n      });\n\n      // Capture SMs for session trace if active (`ptid` is set when returned by replay ingest).\n      // Retain these SMs while we are working through the session_replay feature\n      if (agentRuntime.ptid) {\n        this.storeSupportabilityMetrics('PageSession/Feature/SessionTrace/DurationMs', Math.round(performance.now()));\n      }\n\n      // Capture SMs for performance markers and measures to assess the usage and possible inclusion of this\n      // data in the agent for use in NR\n      if (typeof performance !== 'undefined') {\n        const markers = performance.getEntriesByType('mark');\n        const measures = performance.getEntriesByType('measure');\n        this.storeSupportabilityMetrics('Generic/Performance/Mark/Seen', markers.length);\n        this.storeSupportabilityMetrics('Generic/Performance/Measure/Seen', measures.length);\n      }\n    } catch (e) {\n      // do nothing\n    }\n  }\n}"],"names":["HarvestScheduler","SharedContext","constructor","endpoint","opts","parent","_this$sharedContext","super","this","started","timeoutHandle","aborted","harvest","Harvest","sharedContext","subscribeToEOL","unload","bind","ee","on","SESSION_EVENTS","RESET","runHarvest","forceNoRetry","onUnload","startTimer","interval","initialDelay","scheduleHarvest","stopTimer","permanently","arguments","length","undefined","clearTimeout","delay","setTimeout","cbRanAfterSend","result","retry","onHarvestFinished","submitMethod","payload","harvests","getPayload","submitData","isFinalHarvest","Object","prototype","toString","call","push","send","args","sendX","raw","_send","forEach","cbFinished","customUrl","onFinished","sent","retryDelay","isWorkerScope","globalScope","cleanupTasks","origClose","close","task","cb","isBrowserScope","subscribeToVisibilityChange","windowAddEventListener","FRAMEWORKS","getFrameworks","frameworks","hasOwnProperty","window","document","querySelector","divs","querySelectorAll","i","err","detectReact","next","detectNextJS","detectVue","$nuxt","detectNuxtJS","detectAngular","detectAngularUniversal","detectSvelte","keys","find","prop","startsWith","detectSvelteKit","detectPreact","detectPreactSSR","detectAngularJs","navigator","userAgent","indexOf","detectElectron","Aggregate","AggregateBase","agentIdentifier","aggregator","scheduler","FEATURE_NAME","registerHandler","blocked","featureName","SUPPORTABILITY_METRIC_CHANNEL","storeSupportabilityMetrics","CUSTOM_METRIC_CHANNEL","storeEventMetrics","singleChecks","eachSessionChecks","concat","body","take","drain","name","value","type","SUPPORTABILITY_METRIC","params","storeMetric","metrics","CUSTOM_METRIC","store","distMethod","loaderType","getRuntime","_document","nonce","currentScript","onDOMContentLoaded","framework","isFileProtocol","rules","getRules","validateRules","proxy","privacy","getConfiguration","assets","beacon","cookies_enabled","evt","persisted","_performance","resourcesSent","agentRuntime","ajaxResources","internalUrls","isAjax","x","includes","initiatorType","performance","getEntriesByType","entry","some","y","ptid","Math","round","now","markers","measures","e","_defineProperty"],"sourceRoot":""}