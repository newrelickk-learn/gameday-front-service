"use strict";(self.webpackChunkfront=self.webpackChunkfront||[]).push([[242],{1043:(t,e,i)=>{function s(t){var e=this;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=(null===s||void 0===s?void 0:s.leading)||!1;let n;return function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];r&&void 0===n&&(t.apply(e,o),n=setTimeout((()=>{n=clearTimeout(n)}),i)),r||(clearTimeout(n),n=setTimeout((()=>{t.apply(e,o)}),i))}}function r(t){var e=this;let i=!1;return function(){if(!i){i=!0;for(var s=arguments.length,r=new Array(s),n=0;n<s;n++)r[n]=arguments[n];t.apply(e,r)}}}i.d(e,{D:()=>s,Z:()=>r})},839:(t,e,i)=>{i.d(e,{setupAgentSession:()=>D});var s=i(8958),r=i(7552),n=i(4836),o=i(4613),a=i(662),h=i(1760),c=i(8038);class l{constructor(t,e){if(!t.onEnd)throw new Error("onEnd handler is required");if(!e)throw new Error("ms duration is required");this.onEnd=t.onEnd,this.initialMs=e,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,e)}create(t,e){return this.timer&&this.clear(),setTimeout((()=>t?t():this.onEnd()),e||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}var u=i(3980),d=i(2162),m=i(536),v=i(1043);class p extends l{constructor(t,e){super(t,e),this.onPause="function"===typeof t.onPause?t.onPause:()=>{},this.onRefresh="function"===typeof t.onRefresh?t.onRefresh:()=>{},this.onResume="function"===typeof t.onResume?t.onResume:()=>{},this.remainingMs=void 0,t.refreshEvents||(t.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch(s){}if(u.il&&t.ee){var i;if(t.ee){this.ee=t.ee;const e=(0,v.D)(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=i=>{var s;t.refreshEvents.includes(null===i||void 0===i||null===(s=i[0])||void 0===s?void 0:s.type)&&e()},t.ee.on("fn-end",this.refreshHandler)}(0,m.N)((t=>{"hidden"===t?this.pause():this.resume()}),!1,!1,null===(i=this.abortController)||void 0===i?void 0:i.signal)}}abort(){var t;this.clear(),null===(t=this.abortController)||void 0===t||t.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){this.refresh(),this.onResume()}refresh(t,e){this.clear(),this.timer=this.create(t,e),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}var f=i(5950),g=i(8673),y=i(5894),w=i(6477),M=i(9025),A=i(1997);const S={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:d.IK.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:d.IK.OFF,traceHarvestStarted:!1,custom:{}};class E{constructor(t){const{agentIdentifier:e,key:i,storage:s}=t;if(!e||!i||!s)throw new Error("Missing required field(s):".concat(e?"":" agentID").concat(i?"":" key").concat(s?"":" storage"));this.agentIdentifier=e,this.storage=s,this.state={},this.key=i,this.ee=n.ee.get(e),(0,f.em)(this.ee),this.setup(t),u.il&&(0,A.bP)("storage",(t=>{if(t.key===this.lookupKey){const e="string"===typeof t.newValue?JSON.parse(t.newValue):t.newValue;this.sync(e),this.ee.emit(d.wO.UPDATE,[d.uT.CROSS_TAB,this.state])}}))}setup(t){let{value:e=(0,a.ky)(16),expiresMs:i=d.oD,inactiveMs:s=d.Hb}=t;this.state={},this.sync(S),this.state.value=e,this.expiresMs=i,this.inactiveMs=s;const r=this.read();i?(this.state.expiresAt=(null===r||void 0===r?void 0:r.expiresAt)||this.getFutureTimestamp(i),this.expiresTimer=new l({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,s?(this.state.inactiveAt=(null===r||void 0===r?void 0:r.inactiveAt)||this.getFutureTimestamp(s),this.inactiveTimer=new p({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(d.wO.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(d.wO.PAUSE),this.write((0,g.D)(this.state,S))},ee:this.ee,refreshEvents:["click","keydown","scroll"]},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew=!Object.keys(r).length,this.isNew?this.write((0,g.D)(this.state,S),!0):this.sync(r),this.initialized=!0}get lookupKey(){return"".concat(d.Bq,"_").concat(this.key)}sync(t){Object.assign(this.state,t)}read(){try{const t=this.storage.get(this.lookupKey);if(!t)return{};const e="string"===typeof t?JSON.parse(t):t;return this.isInvalid(e)?{}:this.isExpired(e.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",e,!0),this.reset()):this.isExpired(e.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",e,!0),this.reset()):e}catch(t){return(0,h.Z)("Failed to read from storage API",t),{}}}write(t){try{if(!t||"object"!==typeof t)return;return t.updatedAt=Date.now(),this.sync(t),this.storage.set(this.lookupKey,(0,c.P)(this.state)),this.ee.emit(d.wO.UPDATE,[d.uT.SAME_TAB,this.state]),t}catch(e){return(0,h.Z)("Failed to write to the storage API",e),null}}reset(){try{var t,e,i,s;return this.initialized&&this.ee.emit(d.wO.RESET),this.storage.remove(this.lookupKey),null===(t=this.inactiveTimer)||void 0===t||null===(e=t.abort)||void 0===e||e.call(t),null===(i=this.expiresTimer)||void 0===i||null===(s=i.clear)||void 0===s||s.call(i),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs}),this.read()}catch(r){return{}}}refresh(){const t=this.read();this.write({...t,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(t){return Date.now()>t}isInvalid(t){return!Object.keys(S).every((e=>Object.keys(t).includes(e)))}collectSM(t,e,i){let s,r;"duration"===t&&(s=this.getDuration(e,i),r="Session/Duration/Ms"),"expired"===t&&(r="Session/Expired/Seen"),"inactive"===t&&(r="Session/Inactive/Seen"),r&&(0,y.p)(w.xS,[r,s],void 0,M.D.metrics,this.ee)}getDuration(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state,e=arguments.length>1?arguments[1]:void 0;const i=t.expiresAt-this.expiresMs;return(e?Date.now():t.updatedAt)-i}getFutureTimestamp(t){return Date.now()+t}syncCustomAttribute(t,e){if(u.il)if(null===e){const e=this.read();e.custom&&(delete e.custom[t],this.write({...e}))}else{const i=this.read();this.custom={...(null===i||void 0===i?void 0:i.custom)||{},[t]:e},this.write({...i,custom:this.custom})}}}class k{get(t){try{return localStorage.getItem(t)||void 0}catch(e){return""}}set(t,e){try{return void 0===e||null===e?this.remove(t):localStorage.setItem(t,e)}catch(i){}}remove(t){try{localStorage.removeItem(t)}catch(e){}}}class T{constructor(t){this.domain=t}get(t){try{var e=document.cookie.match(new RegExp("(^| )"+t+"=([^;]+)"));if(e)return e[2]}catch(i){return""}}set(t,e){try{const i="".concat(t,"=").concat(e,"; Domain=").concat(this.domain,"; Path=/");document.cookie=i}catch(i){}}remove(t){try{document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; Domain=").concat(this.domain,"; Path=/")}catch(e){}}}let x=0;function D(t){const e=(0,s.OP)(t);if(x++)return e.session;const i=(0,s.P_)(t).session,a=null!==i&&void 0!==i&&i.domain?new T(i.domain):new k;e.session=new E({agentIdentifier:t,key:"SESSION",storage:a,expiresMs:null===i||void 0===i?void 0:i.expiresMs,inactiveMs:null===i||void 0===i?void 0:i.inactiveMs});const h=e.session.state.custom,c=(0,s.C5)(t);h&&(c.jsAttributes={...c.jsAttributes,...h});const l=n.ee.get(t);return(0,o.X)("api-setCustomAttribute",((t,i,s)=>{e.session.syncCustomAttribute(i,s)}),"session",l),(0,o.X)("api-setUserId",((t,i,s)=>{e.session.syncCustomAttribute(i,s)}),"session",l),(0,r.L)(t,"session"),e.session}}}]);
//# sourceMappingURL=session-manager.84f12be3.chunk.js.map